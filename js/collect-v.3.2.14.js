var __tea_iife_export__=function(e){"use strict";function t(e,t){var r=e.exec(t);return r&&r[1]?r[1]:""}function r(e,t,r){if("string"==typeof e&&"number"==typeof t&&"number"==typeof r){var n=[],i=[];r=r<=25?r:r%25;var o=String.fromCharCode(r+97);n=e.split(o);for(var a=0;a<n.length;a++){var s=parseInt(n[a],r);s=1*s^t;var u=String.fromCharCode(s);i.push(u)}return i.join("")}}function n(e){return e?(e^16*Math.random()>>e/4).toString(10):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,n)}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},s=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},u=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},c=void 0,d=function e(){var t=this;o(this,e),this.set=function(e,r){var n=e,i=r;if(null===i)return!1;var o="";if(n.indexOf(".")>-1){var a=n.split(".");o=a[0],n=a[1]}"os_version"===n&&(i=""+i),o?"user"===o||"header"===o?t.envInfo[o][n]=i:"headers"===o?t.envInfo.header.headers[n]=i:t.envInfo.header.headers.custom[n]=i:t.envInfo.user.hasOwnProperty(n)?["user_type","device_id","ip_addr_id"].indexOf(n)>-1?t.envInfo.user[n]=Number(i):["user_id","web_id","user_unique_id","ssid"].indexOf(n)>-1?t.envInfo.user[n]=String(i):["user_is_auth","user_is_login"].indexOf(n)>-1&&(t.envInfo.user[n]=Boolean(i)):t.envInfo.header.hasOwnProperty(n)?t.envInfo.header[n]=i:t.envInfo.header.headers.hasOwnProperty(n)?t.envInfo.header.headers[n]=i:t.envInfo.header.headers.custom[n]=i},this.get=function(){for(var e={user:{},header:{headers:{custom:{}}}},r=t.envInfo,n=r.user,i=Object.keys(n),o=Array.isArray(i),s=0,i=o?i:i[Symbol.iterator]();;){var u;if(o){if(s>=i.length)break;u=i[s++]}else{if((s=i.next()).done)break;u=s.value}var d=u;n[d]!==c&&(e.user[d]=n[d])}for(var l=r.header,f=Object.keys(l),_=Array.isArray(f),p=0,f=_?f:f[Symbol.iterator]();;){var h;if(_){if(p>=f.length)break;h=f[p++]}else{if((p=f.next()).done)break;h=p.value}var v=h;l[v]!==c&&"headers"!==v&&(e.header[v]=l[v])}for(var g=r.header.headers,m=Object.keys(g),y=Array.isArray(m),b=0,m=y?m:m[Symbol.iterator]();;){var w;if(y){if(b>=m.length)break;w=m[b++]}else{if((b=m.next()).done)break;w=b.value}var k=w;"custom"!==k&&g[k]!==c&&(e.header.headers[k]=g[k])}var S=r.header.headers.custom,O=Object.keys(S);if(O.length)for(var z=O,I=Array.isArray(z),C=0,z=I?z:z[Symbol.iterator]();;){var E;if(I){if(C>=z.length)break;E=z[C++]}else{if((C=z.next()).done)break;E=C.value}var R=E;e.header.headers.custom[R]=S[R]}return{user:e.user,header:a({},e.header,{headers:e.header.headers})}},this.envInfo={user:{user_unique_id:c,user_type:c,user_id:c,user_is_auth:c,user_is_login:c,device_id:c,web_id:c,ip_addr_id:c,ssid:c},header:{app_id:c,app_name:c,app_install_id:c,app_package:c,app_channel:c,app_version:c,os_name:c,os_version:c,device_model:c,ab_client:c,ab_version:c,traffic_type:c,utm_source:c,utm_medium:c,utm_campaign:c,client_ip:c,device_brand:c,os_api:c,access:c,language:c,region:c,app_language:c,app_region:c,creative_id:c,ad_id:c,campaign_id:c,log_type:c,rnd:c,platform:c,sdk_version:c,province:c,city:c,timezone:c,tz_offset:c,tz_name:c,sim_region:c,carrier:c,resolution:c,browser:c,browser_version:c,referrer:c,referrer_host:c,headers:{utm_term:c,utm_content:c,custom:{}}}}},l=function(e){var t=document.createElement("a");return t.href=e,t},f=screen.width||0,_=screen.height||0,p=f+" x "+_,h=navigator.appVersion,v=navigator.userAgent,g=navigator.language,m=document.referrer,y=l(m).hostname,b=function(e){var t=l(e).search,r={};return(t=t.slice(1)).split("&").forEach(function(e){var t=e.split("="),n=t[0],i=t[1];r[n]=decodeURIComponent(void 0===i?"":i)}),r}(location.href),w="",k="",S="",O=""+parseFloat(h),z=void 0,I=void 0;-1!==(z=v.indexOf("Opera"))&&(S="Opera",O=v.substring(z+6),-1!==(z=v.indexOf("Version"))&&(O=v.substring(z+8))),-1!==(z=v.indexOf("Edge"))?(S="Microsoft Edge",O=v.substring(z+5)):-1!==(z=v.indexOf("MSIE"))?(S="Microsoft Internet Explorer",O=v.substring(z+5)):-1!==(z=v.indexOf("Chrome"))?(S="Chrome",O=v.substring(z+7)):-1!==(z=v.indexOf("Safari"))?(S="Safari",O=v.substring(z+7),-1!==(z=v.indexOf("Version"))&&(O=v.substring(z+8))):-1!==(z=v.indexOf("Firefox"))&&(S="Firefox",O=v.substring(z+8)),-1!==(I=O.indexOf(";"))&&(O=O.substring(0,I)),-1!==(I=O.indexOf(" "))&&(O=O.substring(0,I)),-1!==(I=O.indexOf(")"))&&(O=O.substring(0,I));for(var C=/Mobile|htc|mini|Android|iP(ad|od|hone)/.test(h)?"wap":"web",E=[{s:"Windows 10",r:/(Windows 10.0|Windows NT 10.0)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Android",r:/Android/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/}],R=0;R<E.length;R++){var x=E[R];if(x.r.test(v)){w=x.s;break}}switch(/Windows/.test(w)&&(k=t(/Windows (.*)/,w),w="windows"),w){case"Mac OS X":k=t(/Mac OS X (10[\.\_\d]+)/,v),w="mac";break;case"Android":k=function(e){var r=t(/Android ([\.\_\d]+)/,e);return r||(r=t(/Android\/([\.\_\d]+)/,e)),r}(v),w="android";break;case"iOS":k=(k=/OS (\d+)_(\d+)_?(\d+)?/.exec(h))?k[1]+"."+k[2]+"."+(0|k[3]):"",w="ios"}var T={screen_size:p,browser:S,browser_version:O,platform:C,os_name:w,os_version:k,userAgent:v,screen_width:f,screen_height:_,device_model:w,language:g,referrer:m,referrer_host:y,utm_source:b.utm_source,utm_medium:b.utm_medium,utm_campaign:b.utm_campaign,utm_term:b.utm_term,utm_content:b.utm_content},q=function(){return("ios"!==w||"safari"!==S)&&(!(!window.navigator||!window.navigator.sendBeacon)||void 0)},D=function e(){var t=this;o(this,e),this.setItem=function(e,r){t.cache[e]=r},this.getItem=function(e){return t.cache[e]},this.removeItem=function(e){t.cache[e]=void 0},this.clear=function(){t.cache={}},this.cache={}};new D;var A={getItem:function(e){try{var t=localStorage.getItem(e),r=t;try{t&&"string"==typeof t&&(r=JSON.parse(t))}catch(e){}return r||void 0}catch(e){}},setItem:function(e,t){try{var r="string"==typeof t?t:JSON.stringify(t);localStorage.setItem(e,r)}catch(e){}},removeItem:function(e){try{localStorage.removeItem(e)}catch(e){}},clear:function(){try{localStorage.clear()}catch(e){}},isSupportLS:function(){try{return localStorage.setItem("_____tea-sdk-test-key","hi"),localStorage.getItem("_____tea-sdk-test-key"),localStorage.removeItem("_____tea-sdk-test-key"),!0}catch(e){return!1}}()},M=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];o(this,e);var r=!t&&A.isSupportLS;this._storage=r?A:new D}return e.prototype.getItem=function(e){return this._storage.getItem(e)},e.prototype.setItem=function(e,t){this._storage.setItem(e,t)},e.prototype.removeItem=function(e){this._storage.removeItem(e)},e.prototype.clear=function(){this._storage.clear()},e}(),P="__tea_cache_",N={NO_URL_PREFIX:4001,IMG_ON_ERROR:4e3,IMG_CATCH_ERROR:4002,BEACON_STATUS_FALSE:4003,XHR_ON_ERROR:500,RESPONSE_DATA_ERROR:5001},U=function e(){var t=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";o(this,e),this.init=function(e){t.isLog=e},this.info=function(e){for(var r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];if(t.isLog){var o;(o=console).log.apply(o,[t.prefix+e].concat(n))}},this.warn=function(e){for(var r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];if(t.isLog){var o;(o=console).warn.apply(o,[t.prefix+e].concat(n))}},this.error=function(e){for(var r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];if(t.isLog){var o;(o=console).error.apply(o,[t.prefix+e].concat(n))}},this.dir=function(){if(t.isLog){var e;(e=console).dir.apply(e,arguments)}},this.table=function(e){t.isLog&&console.table(e)},this.logJSON=function(e){"object"===(void 0===e?"undefined":i(e))&&t.isLog&&t.info("",JSON.stringify(e,null,2))},this.deprecated=function(e){for(var r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];t.warn.apply(t,["[DEPRECATED]"+e].concat(n))},this.throw=function(e){throw t.error(t.prefix),new Error(e)};var n=r?"["+r+"]":"";this.prefix="[tea-sdk]"+n},j=new U,L=function(e,t,r,n){var i=t.app_key;delete t.app_key;var o=new XMLHttpRequest;o.open("POST",e,!0),o.setRequestHeader("Content-Type","application/json; charset=utf-8"),i&&o.setRequestHeader("X-MCS-AppKey",""+i),o.onload=function(){try{var e=JSON.parse(o.responseText);r&&r(e)}catch(e){n&&n()}},o.onerror=function(){n&&n()},o.send(JSON.stringify(t))},K=(new Date).getTimezoneOffset(),F=parseInt(-K/60,10),W=60*K,J=void 0;try{J="3.2.14"}catch(e){J="2.x"}var X=new(function(e){function t(){o(this,t);var r=u(this,e.call(this));return r.initClientEnv=function(){r.set("os_name",T.os_name),r.set("os_version",T.os_version),r.set("device_model",T.device_model),r.set("platform",T.platform),r.set("sdk_version",J),r.set("browser",T.browser),r.set("browser_version",T.browser_version),r.set("language",T.language),r.set("timezone",F),r.set("tz_offset",W),r.set("resolution",T.screen_width+"x"+T.screen_height),r.set("screen_width",T.screen_width),r.set("screen_height",T.screen_height),r.set("referrer",T.referrer),r.set("referrer_host",T.referrer_host),r.set("utm_source",T.utm_source),r.set("utm_medium",T.utm_medium),r.set("utm_campaign",T.utm_campaign),r.set("utm_term",T.utm_term),r.set("utm_content",T.utm_content)},r.initClientEnv(),r}return s(t,e),t}(d)),V=new(function(){function e(){o(this,e)}return e.prototype.isString=function(e){return"String"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isNumber=function(e){return"Number"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isBoolean=function(e){return"Boolean"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isFunction=function(e){return"Function"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isNull=function(e){return"Null"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isUndefined=function(e){return"Undefined"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isObj=function(e){return"Object"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isArray=function(e){return"Array"===Object.prototype.toString.call(e).slice(8,-1)},e.prototype.isFalse=function(e){return""===e||void 0===e||null===e||"null"===e||"undefined"===e||0===e||!1===e||NaN===e},e.prototype.isTrue=function(e){return!this.isFalse(e)},e.prototype.isLowIE=function(){return window.XDomainRequest},e}()),B=function(e){return r(e,64,25)},Q=function(){return n().replace(/-/g,"").slice(0,19)},H=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(e){return e},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5,n=[],i=0,o=void 0;return e.forEach(function(e){var a=t(e);void 0===o?o=a:(a!==o||n[i].length>=r)&&(i+=1,o=a),n[i]=n[i]||[],n[i].push(e)}),n},G={cn:"1fz22z22z1nz21z4mz4bz4bz1kz1az21z4az21z1lz21z21z1bz1iz4az1az1mz1k",sg:"1fz22z22z1nz21z4mz4bz4bz21z1ez18z1jz1gz49z1kz1az21z4az19z27z22z1cz1mz24z1cz20z21z1cz18z4az1az1mz1k",va:"1fz22z22z1nz21z4mz4bz4bz1kz18z1jz1gz24z18z49z1kz1az21z4az19z27z22z1cz1mz24z1cz20z21z1cz18z4az1az1mz1k"},$=function(e){try{var t=document.cookie.match(new RegExp("(?:^|;)\\s*"+e+"=([^;]+)"));return decodeURIComponent(t?t[1]:"")}catch(e){return""}},Y=function(e){function t(){o(this,t);var r=u(this,e.call(this));return r.init=function(e){var t=e.app_key,n=e.app_id,i=e.channel,o=e.log,a=e.channel_domain,s=e.name;if(!t&&!n)throw new Error("没有传入 app_key 或 app_id ");if(n&&"number"!=typeof n)throw new Error("app_id 必须是一个数字，注意检查是否是以`string`的方式传入的？");if(t&&"string"!=typeof t)throw new Error("app_key 必须是字符串类型。");r.app_id=n,r.app_key=t,r.appIdentification=t||n,r.logger=new U(s),r.logger.init(o),r.initConfigs(e),r.initUrls(i,a),r.checkUserToken(),r.setEnv("app_id",n)},r.initConfigs=function(e){var t=e.disable_ssid,n=e.disable_webid,i=e.disable_sdk_monitor;r.evtDataCacheKey=P+"events_"+r.appIdentification,t&&(r.logger.info("ssid已禁用，设置user_unique_id不会请求ssid接口。"),r.isSsidDisabled=!0),n&&(r.logger.info("webid服务已禁用，ssid同时被禁用。将本地生成webid。"),r.isWebidDisabled=!0,r.isSsidDisabled=!0),i&&(r.logger.info("SDK监控已禁用。"),r.isSdkMonitorDisabled=!0)},r.initUrls=function(e,t){if("internal"===e&&(r.logger.warn("channel 的值 internal 已被废弃，已自动改为 cn。"),e="cn"),!t&&!G[e])throw new Error("channel 变量只能是 `cn`, `sg`,`va`");var n=t||B(G[e]);n=n.replace(/\/+$/,""),r.reportUrl=n+"/v1/list",r.userTokensPrefix=""+n},r.setEnv=function(e,t){if("user_unique_id"===e){if(r.blackUuid.some(function(e){return e===String(t)}))return void r.logger.warn('设置了无效的值 {user_unique_id："%s"}。该操作已忽略。',t);r.verifyTokens(t)}if("web_id"===e){if(!t)return;(!r.envInfo.user.user_unique_id||r.envInfo.user.user_unique_id&&r.envInfo.user.user_unique_id===r.envInfo.user.web_id)&&r.set("user_unique_id",t)}r.set(e,t)},r.transferFromCookie=function(){var e=r.tokensCacheKey,t=$("tt_webid"),n=$("__tea_sdk__ssid"),i=$("__tea_sdk__user_unique_id");if(V.isLowIE()){if(t){var o={web_id:t,ssid:t,user_unique_id:t};r.storageClient.setItem(e,o)}return!1}if(t&&n&&i){var a={web_id:t,ssid:n,user_unique_id:i};r.storageClient.setItem(e,a)}},r.purifyBlackUuid=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(r.blackUuid.some(function(t){return t===e.user_unique_id})){var t={};return r.setUserTokens(t),r.logger.warn('检测到无效的用户标识，已重置用户状态。{user_unique_id: "%s"}',e.user_unique_id),t}return e},r.getUserTokens=function(){return r.storageClient.getItem(r.tokensCacheKey)||{}},r.setUserTokens=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r.storageClient.setItem(r.tokensCacheKey,e)},r.checkUserToken=function(){var e=P+"tokens_"+r.appIdentification;r.tokensCacheKey=e,r.transferFromCookie();var t=r.purifyBlackUuid(r.getUserTokens());t.user_unique_id&&t.web_id?(r.envInfo.user.user_unique_id=t.user_unique_id,r.envInfo.user.web_id=t.web_id,r.envInfo.user.ssid=t.ssid||"",r.logger.info("初始化已经检测到了 webid user_unique_id，一般情况下不需要再次验证 id 了"),r.unlock()):r.requestWebId()},r.saveTokenToStorage=function(e){var t=e.web_id,n=e.ssid,i=e.user_unique_id;r.setUserTokens({web_id:t,ssid:n,user_unique_id:i})},r.requestWebId=function(){r.isRequestWebId=!0;var e=function(e){var t=r.envInfo.user.web_id||e.web_id,n=e.ssid;r.isRequestWebId=!1,r.envInfo.user.ssid=n,r.envInfo.user.web_id=t,r.envInfo.user.user_unique_id=t,r.saveTokenToStorage({web_id:t,ssid:n,user_unique_id:t}),r.waitForVerifyTokens?(r.lock(),r.verifyTokens(r.realUuid)):(r.unlock(),r.callback&&r.callback())};r.isWebidDisabled?function(){e({web_id:Q(),ssid:""})}():function(){var t=r.userTokensPrefix+"/v1/user/webid";L(t,{app_key:r.app_key,app_id:r.app_id,url:location.href,user_agent:T.userAgent,referer:T.referrer,user_unique_id:""},function(t){0!==t.e?r.logger.error("请求 webid 失败。请联系管理员。"):e(t)},function(){r.isRequestWebId=!1,r.logger.error("获取 webid 失败，数据将不会被上报")})}()},r.verifyTokens=function(e){var t=r.tokensCacheKey;if(r.waitForVerifyTokens=!1,r.realUuid=""+e,r.isRequestWebId)return r.waitForVerifyTokens=!0,r.logger.info("正在请求 webid，requestSsid 将会在前者请求完毕之后被调用"),!1;var n=r.getUserTokens();if(n.user_unique_id===r.realUuid&&n.ssid&&n.web_id)r.logger.info("传入的 user_id/user_unique_id 与 缓存中的完全一致，无需再次请求"),r.unlock();else{r.lock(),r.envInfo.user.user_unique_id=r.realUuid;var i=a({},r.getUserTokens(),{user_unique_id:r.realUuid});if(r.storageClient.setItem(t,i),V.isLowIE())return r.unlock(),!1;r.isSsidDisabled?(r.unlock(),r.callback&&r.callback()):r.requestSsid()}},r.requestSsid=function(){var e=r.getUserTokens(),t=r.userTokensPrefix+"/v1/user/ssid";L(t,{app_key:r.app_key,app_id:r.app_id,web_id:e.web_id,user_unique_id:""+e.user_unique_id},function(t){if(0!==t.e)r.logger.error("请求 ssid 失败~"),r.unlock();else{r.envInfo.user.ssid=t.ssid;var n=a({},e,{ssid:t.ssid});r.setUserTokens(n),r.logger.info("根据 user_unique_id 更新 ssid 成功！注意：在这之前不应该有数据被发出去"),r.unlock(),r.callback&&r.callback()}},function(){r.unlock(),r.logger.error("根据 user_unique_id 获取新 ssid 失败")})},r.setEvtParams=function(e){var t=a({},e);Object.keys(t).forEach(function(e){r.evtParams[e]=t[e]})},r.mergeEnvToEvents=function(e){var t=r.mergeEnv();return H(e,function(e){return!!e.params.__disable_storage__}).map(function(e){return{events:e.map(function(e){var t=a({},r.evtParams,e.params);return delete t.__disable_storage__,a({},e,{params:JSON.stringify(t)})}),user:t.user,header:t.header,verbose:r.debugMode?1:void 0,__disable_storage__:e[0].params.__disable_storage__}})},r.mergeEnv=function(){var e=r.get(),t=X.get(),n=a({},e.user),i=a({},t.header.headers.custom,e.header.headers.custom),o=a({},t.header.headers,e.header.headers,{custom:i}),s=a({},t.header,e.header);return{user:n,header:a({},s,{headers:JSON.stringify(o)})}},r.evtParams={},r.reportUrl="",r.userTokensPrefix="",r.isSsidDisabled=!1,r.isWebidDisabled=!1,r.isSdkMonitorDisabled=!1,r.debugMode=!1,r.blackUuid=["null","undefined","0","","None"],r.logger=function(){},r.storageClient=new M,r}return s(t,e),t.prototype.lock=function(){this.isUserTokensReady=!1},t.prototype.unlock=function(){this.isUserTokensReady=!0},t.prototype.enableDebugMode=function(e){this.debugMode=e},t}(d),Z=function(){function e(t){var r=t.disable_storage,n=void 0!==r&&r;o(this,e),this._storage=new M(n),this._storageKey="",this._data=void 0}return e.prototype.setStorageKey=function(e){this._storageKey=e},e.prototype.getAllEvents=function(){var e=this.getData();Object.keys(e).reduce(function(t,r){return t.concat(e[r]||[])},[])},e.prototype.getData=function(){return this._checkIsDataInit(),this._data},e.prototype.add=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this._checkIsDataInit(),0!==t.length&&(this._data[e]=t,this._save())},e.prototype.delete=function(e){this._checkIsDataInit(),this._data[e]&&(delete this._data[e],this._save())},e.prototype._checkIsDataInit=function(){if(void 0===this._data)try{var e=this._getDataFromStorage();if(V.isArray(e)){var t;this._data=(t={},t[Q()]=e,t),this._save()}else this._data=e}catch(e){this._data={}}},e.prototype._checkStorageKey=function(){if(!this._storageKey)throw new Error("must call setStorageKey('xxx') first")},e.prototype._getDataFromStorage=function(){return this._checkStorageKey(),this._storage.getItem(this._storageKey)||{}},e.prototype._save=function(){this._checkStorageKey(),this._storage.setItem(this._storageKey,this._data)},e}(),ee=function(e){var t="";for(var r in e)e.hasOwnProperty(r)&&(t+="&"+r+"="+encodeURIComponent(JSON.stringify(e[r])));return t="&"===t[0]?t.slice(1):t},te=function(e,t){try{var r=e.split("v1")[0];t.forEach(function(e){var t=ee(e),n=new Image(1,1);n.onload=function(){n=null},n.onerror=function(){n=null},n.src=r+"/v1/gif?"+t})}catch(e){}},re=function(e){var t=e.url,r=e.data;if(window.XDomainRequest)return te(t,r);var n=new XMLHttpRequest;n.open("POST",t+"?rdn="+Math.random(),!0),n.setRequestHeader("X-MCS-AppKey","566f58151b0ed37e"),n.onload=function(){},n.onerror=function(){n.abort()},n.send(JSON.stringify(r))},ne=function(e){var t="";for(var r in e)e.hasOwnProperty(r)&&(t+="&"+r+"="+encodeURIComponent(JSON.stringify(e[r])));return t="&"===t[0]?t.slice(1):t},ie=function(e,t,r,n){try{var i=e.split("v1")[0];if(!i)return void n(e,t,N.NO_URL_PREFIX);t.forEach(function(o){var a=ne(o),s=new Image(1,1);s.onload=function(){s=null,r()},s.onerror=function(){s=null,n(e,t,N.IMG_ON_ERROR)},s.src=i+"/v1/gif?"+a})}catch(r){n(e,t,N.IMG_CATCH_ERROR,r.message)}},oe=function(e){var t=e.app_key,r=e.url,n=e.data,i=e.success,o=e.fail,a=e.notSure,s=e.isUnload,u=!!t,c=n;if(!u&&window.XDomainRequest)return void ie(r,c,i,o);if(!u&&s)return q()?(a(),void(window.navigator.sendBeacon(r,JSON.stringify(c))?i():o(r,n,N.BEACON_STATUS_FALSE))):void ie(r,c,i,o);var d=new XMLHttpRequest;d.open("POST",r+"?rdn="+Math.random(),!0),d.setRequestHeader("Content-Type","application/json; charset=utf-8"),t&&d.setRequestHeader("X-MCS-AppKey",""+t),d.onload=function(){i(r,c,d.responseText)},d.onerror=function(){d.abort(),o(r,c,N.XHR_ON_ERROR)},d.send(JSON.stringify(c))},ae=function e(t){var r=this;o(this,e),this.send=function(e){var t=e.url,n=e.data,i=e.success,o=e.fail,a=e.eventError,s=e.notSure,u=e.isUnload;if(oe({app_key:r.app_key,url:t,data:n,success:function(e,t,n){i();try{var o=JSON.parse(n).e;if(0!==o){var s="未知错误";-2===o&&(s="事件格式错误！请检查字段类型是否正确。"),r.logger.error("数据上报失败！","错误码："+o+"。错误信息："+s),a(t,o),ue({app_key:r.app_key,url:e,eventData:t,errorCode:o})}}catch(n){ue({app_key:r.app_key,url:e,eventData:t,errorCode:N.RESPONSE_DATA_ERROR})}},fail:function(e,t,n){r.logger.error("数据上报失败！","错误码："+n),o(t,n),ue({app_key:r.app_key,url:e,eventData:t,errorCode:n})},notSure:s,isUnload:u}),!r.isSdkMonitorDisabled&&!r.isSdkOnLoadEventReady){r.isSdkOnLoadEventReady=!0;try{se({app_key:r.app_key,url:t,data:n})}catch(e){}}};var n=t.logger,i=t.app_key;this.app_key=i,this.logger=n||j,this.isSdkOnLoadEventReady=!1,this.isSdkMonitorDisabled=!1},se=function(e){var t=e.app_key,r=e.url,n=e.data;try{var i=n[0],o=i.header,a=i.user,s=o.app_id,u=o.app_name,c=o.sdk_version,d=a.web_id,l={events:[{event:"onload",params:JSON.stringify({app_key:t,app_id:s,app_name:u||"",sdk_version:c}),local_time_ms:Date.now()}],user:{user_unique_id:d},header:{}};setTimeout(function(){re({url:r,data:[l]})},16)}catch(e){}},ue=function(e){var t=e.app_key,r=e.url,n=e.eventData,i=e.errorCode;try{var o=n[0],a=o.user,s=o.header,u=[];n.forEach(function(e){e.events.forEach(function(e){u.push(e)})});var c={events:u.map(function(e){return{event:"on_error",params:JSON.stringify({error_code:i,app_key:t,app_id:s.app_id,app_name:s.app_name||"",error_event:e.event,local_time_ms:e.local_time_ms,tea_event_index:Date.now(),params:e.params,header:JSON.stringify(s),user:JSON.stringify(a)}),local_time_ms:Date.now()}}),user:{user_unique_id:a.user_unique_id},header:{}};setTimeout(function(){re({url:r,data:[c]})},16)}catch(e){}},ce=function(e){function t(r){o(this,t);var n=u(this,e.call(this));n.eventReportTimer=null,n.addListener=function(){window.addEventListener("unload",function(){n.report(!0)},!1),window.addEventListener("beforeunload",function(){n.report(!0)},!1),document.addEventListener("visibilitychange",function(){"hidden"===document.visibilityState&&n.report(!0)},!1)},n.setReady=function(e){n.isReady=e,n.eventSender.isSdkMonitorDisabled=n.isSdkMonitorDisabled,n.checkAndSendCachedStorageEvents(),n.report()},n.event=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=n.memoryCacheManager.getItem(n.evtDataCacheKey)||[],i=t?[].concat(e,r):[].concat(r,e);n.memoryCacheManager.setItem(n.evtDataCacheKey,i),i.length>=5?n.report():(n.eventReportTimer&&clearTimeout(n.eventReportTimer),n.eventReportTimer=setTimeout(function(){n.report(),n.eventReportTimer=null},n.waitForBatchTime))},n.report=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!n.isUserTokensReady)return!1;if(!n.isReady)return!1;var t=n.memoryCacheManager.getItem(n.evtDataCacheKey)||[];n.memoryCacheManager.removeItem(n.evtDataCacheKey);var r=n.mergeEnvToEvents(t);n.sendData(r,e)},n.sendData=function(e,t){H(e,function(e){return!!e.__disable_storage__}).forEach(function(e){var r=Q();e[0].__disable_storage__||n.eventStorage.add(r,e),n._sendData(r,e,t)})},n.checkAndSendCachedStorageEvents=function(){var e=n.eventStorage.getData(),t=Object.keys(e);t.length>0&&t.forEach(function(t){n._sendData(t,e[t])})},n._sendData=function(e,t,r){n.isReporting=!0;var i=function(){n.isReporting=!1};n.eventSender.send({url:n.reportUrl,data:t,success:function(){i(),n.sendDataSuccess(e)},fail:function(e,t){i(),n.reportErrorCallback(e,t),setTimeout(function(){n.report()},3e3)},eventError:function(e,t){n.reportErrorCallback(e,t)},notSure:i,isUnload:r})},n.sendDataSuccess=function(e){n.eventStorage.delete(e),n.report()};var i=r.app_key,a=r.log,s=r.disable_storage,c=r.max_batch_num,d=void 0===c?5:c,l=r.batch_time,f=void 0===l?30:l;return n.init(r),n.maxBatchNum=d,n.waitForBatchTime=f,n.isReady=!1,n.addListener(),n.enableDebugMode(!!a),n.memoryCacheManager=new M(!0),n.eventStorage=new Z({disable_storage:s}),n.eventStorage.setStorageKey(n.evtDataCacheKey),n.eventSender=new ae({logger:n.logger,app_key:i}),n.reportErrorCallback=function(){},n}return s(t,e),t.prototype.unlock=function(){e.prototype.unlock.call(this),this.report()},t}(Y),de=function(){var e=+Date.now()+Number((""+Math.random()).slice(2,8));return function(){return e+=1}}(),le=function(e,t){var r=e;/^event\./.test(e)&&(r=e.slice(6));var n=t;return V.isObj(n)||(n={}),n.event_index=de(),{event:r,params:n,local_time_ms:+new Date}},fe=function e(t){var r=this;o(this,e),this.init=function(e){if(!V.isObj(e))throw new Error("init 的参数必须是Object类型");r.logger.init(e.log),r.channel=new ce(a({},e,{name:r.name})),r.channel.callback=function(){r.callbackSend&&r.start()}},this.config=function(e){V.isObj(e)||r.logger.throw("config 参数必须是 {} 的格式"),e.log&&(r.logger.init(!0),r.channel.enableDebugMode(!0),e.log=null);var t=Object.keys(e);if(!t.length)return!1;for(var n=t,i=Array.isArray(n),o=0,n=i?n:n[Symbol.iterator]();;){var a;if(i){if(o>=n.length)break;a=n[o++]}else{if((o=n.next()).done)break;a=o.value}var s=a,u=e[s];switch(s){case"evtParams":r.channel.setEvtParams(u);break;case"disable_ssid":r.logger.deprecated("(disable_ssid)请通过init函数来设置。"),u&&(r.logger.info("ssid已禁用，设置user_unique_id不会请求ssid接口。"),r.channel.isSsidDisabled=u);break;case"disable_auto_pv":u&&(r.logger.info("已禁止默认上报predefine_pageview事件，需手动上报。"),r._autoSendPV=!1);break;case"_staging_flag":""+u=="1"&&r.logger.info("根据_staging_flag设置，数据将会上报到stag 表。"),r.channel.setEvtParams({_staging_flag:Number(u)});break;case"reportErrorCallback":"function"==typeof u&&(r.channel.reportErrorCallback=u);break;default:r.channel.setEnv(s,u)}}},this.send=function(){r.start()},this.start=function(){if(r.channel.isUserTokensReady){if(r._isSendFuncCalled)return;r._isSendFuncCalled=!0,r.logger.info("看到本提示，意味着用户信息已完全就绪，上报通道打开。用户标识如下："),r.logger.logJSON(r.channel.get().user),r._autoSendPV&&r.predefinePageView(),r.channel.setReady(!0)}else r.callbackSend=!0},this.predefinePageView=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t={title:document.title||location.pathname,url:location.href,url_path:location.pathname},n=a({},t,e);r.event("predefine_pageview",n,!0)},this.event=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=V.isBoolean(t[t.length-1]),o=!!i&&t[t.length-1],a=i?t.slice(0,t.length-1):t,s=a[0],u=[];V.isArray(s)?u=a:u[0]=a,u=u.map(function(e){return le.apply(void 0,e)}),r.channel.event(u,o)},this._isSendFuncCalled=!1,this._autoSendPV=!0,this.name=t,this.logger=new U(t)};fe.exportMethods=["init","config","send","start","predefinePageView"];var _e=function e(t){var r=this;return o(this,e),this._exportCollect=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];if(r._isQueueProcessed)return void r._executeCmd.apply(r,t);r.cmdQueue.push(t),r._processCmdQueue()},this._processCmdQueue=function(){if(0!==r.cmdQueue.length){var e=function(e,t,r){var n=-1;return e.forEach(function(e,i){(void 0!==r?e[r]:e)===t&&(n=i)}),n}(r.cmdQueue,"init","0");-1!==e&&(r._isQueueProcessed=!0,r._executeCmd.apply(r,r.cmdQueue[e]),r.cmdQueue.forEach(function(t,n){n!==e&&r._executeCmd.apply(r,t)}),r.cmdQueue=[])}},this._executeCmd=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0];if(fe.exportMethods.indexOf(i)>-1){var o;(o=r.colloctor)[i].apply(o,t.slice(1))}else{var a;(a=r.colloctor).event.apply(a,t)}},this.name=t||"Collector"+ +new Date,this.cmdQueue=[],this.colloctor=new fe(this.name),this._isQueueProcessed=!1,this._processCmdQueue(),this._exportCollect.init=this._exportCollect.bind(this,"init"),this._exportCollect.config=this._exportCollect.bind(this,"config"),this._exportCollect.send=this._exportCollect.bind(this,"send"),this._exportCollect.start=this._exportCollect.bind(this,"start"),this._exportCollect.predefinePageView=this._exportCollect.bind(this,"predefinePageView"),this._exportCollect},pe={},he={},ve=function(e){return pe[e]||(pe[e]=new _e(e)),pe[e]},ge=function(e){return he[e]||(he[e]=[]),he[e]},me=function(e){var t=e[0],r=e[1],n=t.split(".");if(1===n.length)ge("default").push([t,r]);else if(2===n.length)"event"===n[0]?ge("default").push([t,r]):ge(n[0]).push([n[1],r]);else if(3===n.length){var i=n[0],o=[n[1],n[2]].join(".");ge(i).push([o,r])}},ye=function(e,t){t.forEach(function(t){ve(e).apply(void 0,t)})},be=function(){we.q.forEach(function(e){var t=[].slice.call(e);V.isArray(t[0])?t.forEach(function(e){me(e)}):me(t)}),Object.keys(he).forEach(function(e){ye(e,he[e]),he[e]=[]}),we.q=[]},we=function e(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];e.q.push(r),be()};we.q=[],we.l=+new Date,we._instanceMap=pe,we._instanceCmdMap=he,we.init=we.bind(null,"init"),we.config=we.bind(null,"config"),we.send=we.bind(null,"send"),we.start=we.bind(null,"start"),we.predefinePageView=we.bind(null,"predefinePageView"),function(e){var t=window.TeaAnalyticsObject;if(t){if(!window[t])throw new Error("async setup code error!");var r=window[t];e.q=r.q||[],e.l=r.l||+new Date,window[t]=e}}(we),be();var ke=_e;return e.Collector=ke,e.default=we,e}({});
